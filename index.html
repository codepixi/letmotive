<html>
<head>
<!--

Credit : 
https://commons.wikimedia.org/wiki/File:Human-user-trash-full.svg
https://commons.wikimedia.org/wiki/File:Toicon-icon-isometric-save.svg
https://pixabay.com/en/book-orange-thick-blank-art-cover-311431/
https://pixabay.com/en/books-pile-orange-close-library-310520/
-->
<style>

    *
    {
        padding:0;
        margin:0;
    }
    
    li
    {
        list-style-type:none;
        background-color:red;
        width:200px;
        margin:10px;
        padding:10px 10px 5px 10px;
        margin-bottom:5px;
        padding:4px;
        border-radius:10px;
        height:30px;
        text-align:center;
        line-height:30px;
        font-weight:bold;
        color:#333333;
        cursor:hand;    
    }
    
    #actions
    {
        border-bottom:solid 1px #aaaaaa;
    }
    
    #message
    {
        text-align:center;
        font-size:20px;
        color:green;
    }
</style>

<link rel="stylesheet" type="text/css" href="decoration/tableautaches/tableautaches.css"/>
<link rel="stylesheet" type="text/css" href="decoration/calendrier/calendrier.css"/>
<script type="text/javascript" src="lib/picnic.js"></script>
<script type="text/javascript" src="tableautaches.js"></script>
<script type="text/javascript" src="calendrier.js"></script>

</head>
<body>

    <div id="actions">
            <div id="action-tableau-des-taches">
                <a id="action-tableau-des-taches-fermer" href="javascript:fermerTableauTaches()">X</a>
                <a id="action-tableau-des-taches-ouvrir" href="javascript:ouvrirTableauTaches()" style="display:none;">A</a>
                Tableau des t√¢ches possibles 
            </div>            
    </div>

    
    <div id="tableau-des-taches">
    
        <div id="actions-taches">
            <a id="sauve-tache"><span>Sauvegarde</span></a>
            <a id="importe-tache" href="javascript:permettreImportDesTaches()"><span><input type="file" accept=".json" name="importeTaches"/></span></a>
        </div>
        
        <div id="taches">
        

        </div>
        
        <div id="poubelle-tache"><span>Poubelle</span></div>

        <div id="formulaire-nouvelle-tache" style="display:none;"><form method="post" onsubmit="return enregistrerTaches()">
        
        <div>
            <label for="nouvelle-tache-nom">Nom de la tache</label>
            <input type="text" name="nom" id="nouvelle-tache-nom"/>
        </div>
            
        </form></div>
    </div>
	
	<div id="message">&nbsp;</div>
	
	<div id="calendrier">
	
        <div id="actions-calendrier">
            <a id="sauve-calendrier"><span>Sauvegarde</span></a>
            <a id="importe-calendrier" href="javascript:permettreImportDuCalendrier()"><span><input type="file" accept=".json" name="importeCalendrier"/></span></a>
        </div>	
	
        <a class="action-voyager-temps" href="javascript:voyagerTemps(-1)">&lt;&lt;</a>
        <div id="calendrier-jours">
        
        </div>
        <a class="action-voyager-temps" href="javascript:voyagerTemps(1)">&gt;&gt;</a>
	</div>
        
    <script type="text/javascript">
    function verifierTeleversement() 
    {
        return (window.File && window.FileReader && window.FileList && window.Blob);
    }	
    
	function cliquerSimple(obj)
    {
        console.log('cliquerSimple(obj)');
        //console.log('obj ' + obj + ' ' + obj.className);
        //if(obj.className.indexOf("termine") == -1) obj.classList.add("termine");
        //else obj.classList.remove("termine");
    }
    
    function cliquerDouble(obj)
    {
        console.log('cliquerDouble(obj)');
    }
    
	var decompte = 0;
	function appliquerGestures(obj) 
	{
        decompte++;
        if (decompte === 1) {
            clicTimer = setTimeout(function() 
            {
                decompte = 0;
                cliquerSimple(obj);
            }, 300);
        } else if (decompte === 2) {
            clearTimeout(clicTimer);
            decompte = 0;
            cliquerDouble(obj);
        }
    };
    </script>

    
    <script type="text/javascript">
	function verifierListesObligatoires(cible)
	{
        //verifications = [false,false,false,false];
        for(position in listesObligatoires)
        {
            listesObligatoires[position] = false;
        }
        //console.log("Les listes obligatoires sont " + JSON.stringify(listesObligatoires));
        for(position in cible.childNodes)
        {
            contenu = cible.childNodes[position];
            if(contenu.className) listesObligatoires[contenu.className] = true;
        }
        console.log("Listes obligatoires utilisees : " + JSON.stringify(listesObligatoires));
        
        tous = true;
        for(position in listesObligatoires)
        {
            tous = tous && listesObligatoires[position];
        }
        return tous;
	}
	
	function verifierEtatDuJour(jour)
	{        
        console.log("verifierEtatDuJour("+jour+")");
        for(position in listesObligatoires)
        {
            listesObligatoires[position] = false;
        }
        //console.log("Les listes obligatoires sont " + JSON.stringify(listesObligatoires));

        //console.log("calendrier " + localStorage.getItem("calendrier"));
        calendrier = JSON.parse(localStorage.getItem("calendrier"));
        for(position in calendrier[jour])
        {
            tache = calendrier[jour][position];
            //console.log("tache.liste " + tache.liste);
            if(tache.liste) listesObligatoires[tache.liste] = true;
        }
        console.log("Listes obligatoires utilisees : " + JSON.stringify(listesObligatoires));
        
        nombre = 0;
        for(position in listesObligatoires)
        {
            if(listesObligatoires[position]) nombre++;
        }
        switch(nombre) // dependance sur nombre de categoriees == 4
        {
            case 0: return 'vide';
            case 1: case 2: case 3: return 'incomplet';
            case 4: return 'complet';
            
        }
	}

	function verifierListesManquantes(jour)
	{
        //alert(jour + jour);
        cible = jour.childNodes[1];
        //alert(cible);
        
        for(position in listesObligatoires)
        {
            listesObligatoires[position] = false;
        }
        //console.log("Les listes obligatoires sont " + JSON.stringify(listesObligatoires));
        
        for(position in cible.childNodes)
        {
            contenu = cible.childNodes[position];
            if(contenu.className) listesObligatoires[contenu.className] = true;
        }
        console.log("Listes obligatoires utilisees : " + JSON.stringify(listesObligatoires));
        
        manquantes = [];
        for(position in listesObligatoires)
        {
            if(!listesObligatoires[position]) manquantes[manquantes.length] = position;
        }
        return manquantes;
	}
	
	function effacerCompletion()
	{
        document.querySelector("#message").innerHTML = "&nbsp;";
	}
	
	function suggererCompletion(jour)
	{
        manquantes = verifierListesManquantes(jour);
        message = (manquantes.length != 0)?"Il vous manque " + JSON.stringify(manquantes) : "&nbsp;";
        console.log(message);
        document.querySelector("#message").innerHTML = message;
	}
    </script>
    
    <script type="text/javascript">
	function atterrirDansListe(obj, cible)
	{
        console.log("atterrirDansListe()");
        
        var tachesEnregistrees = JSON.parse(localStorage.getItem("taches"));
        localStorage.setItem("taches", JSON.stringify(exporterTaches())); // TODO optimiser
        preparerSauvegardeTaches();
        
        cible.removeChild(obj);
        action = cible.querySelector(".action");
		cible.insertBefore(obj, action);

	}
	function resterDansListe(obj, liste)
	{
        console.log("resterDansListe()");
        //var li = document.createElement('li');
        //li.innerHTML = obj.innerHTML;
        //li.addEventListener('click', function(){appliquerGestures(this)}, false);
		//liste.appendChild(li);
		action = liste.querySelector(".action");
		liste.insertBefore(obj, action);
	}
	function quitterUneListe(obj, liste)
	{
        console.log("quitterUneListe()");
		var objEnDestruction = null;
		var listeTaches = liste.getElementsByTagName('li');
		for(var position = 0; position < listeTaches.length; position++)
		{
			var tache = listeTaches[position];
			if(tache.innerHTML == obj.innerHTML) objEnDestruction = tache;
		}
		//alert(objEnDestruction);
		liste.removeChild(objEnDestruction);
		//delete tableauTaches[liste.id][tache.innerHTML];
	}
	function quitterUneJournee(obj, plan)
	{
        console.log("quitterUneJournee()");
		var objEnDestruction = null;
		var listeTaches = plan.getElementsByTagName('li');
		for(var position = 0; position < listeTaches.length; position++)
		{
			var tache = listeTaches[position];
			if(tache.innerHTML == obj.innerHTML) objEnDestruction = tache;
		}
		if(objEnDestruction) if(tableauCalendrier[plan.parentNode.id][objEnDestruction.innerHTML]) delete tableauCalendrier[plan.parentNode.id][objEnDestruction.innerHTML];
		if(plan.contains(objEnDestruction))plan.removeChild(objEnDestruction);
        localStorage.setItem("calendrier", JSON.stringify(exporterCalendrier())); // TODO optimiser 	
        preparerSauvegardeCalendrier();
        console.log("id de la journee a quittee " + plan.parentNode.id);
        etat = verifierEtatDuJour(plan.parentNode.id);
        console.log("la journee est maintenant" + etat);
        plan.className = "plan " + etat;
	}
		
	function atterrirDansJournee(obj, cible)
	{
        console.log("atterrirDansJournee()");
        //var calendrierPlan = JSON.parse(localStorage.getItem("calendrier"));
		//alert(JSON.stringify(exporterCalendrier());
		//var testTache = obj.childNodes[0];
		//if(testTache.className && testTache.className.indexOf('tache') == 0)
        var clone = document.createElement('li');
        clone.className = obj.parentNode.id; // pour la logique des 4 categories par jour
        //clone.addEventListener('click', function(){appliquerGestures(this)}, false);
        clone.innerHTML = '<span class="tache">'+obj.innerHTML+'</span><span class="detail" onclick="editerDetailTache(this)">&nbsp;</span>';
        picnicJoin(clone);
        cible.appendChild(clone);
        localStorage.setItem("calendrier", JSON.stringify(exporterCalendrier())); // TODO optimiser 	
        
        completion = verifierListesObligatoires(cible);
        if(completion) cible.className = "plan complet";
        else cible.className = "plan incomplet";
	}
	
	
	function atterrirDansPoubelle(obj)
	{
        console.log("atterrirDansPoubelle(obj)");
        cible.removeChild(obj);
        localStorage.setItem("taches", JSON.stringify(exporterTaches())); // TODO optimiser 
        preparerSauvegardeTaches();
    }
	
	function fusionnerDansListe(obj, liste)
	{
		if(liste.contains(obj)) liste.removeChild(obj);
	}
        
    function atterrir(obj, cible, origine)
    {
        console.log("atterrir()");
        if(!cible) return false;
		console.log('DRAG & DROP == DEBUT ==');
		console.log('origine : ' + origine + ':' + origine.id + ':' + origine.className + ' ' + origine.innerHTML);
		console.log('obj : ' + obj + ':' + obj.id + ':' + obj.className + ' ' + obj.innerHTML);
		console.log('cible : ' + cible + ':' + cible.id + ':' + cible.className + ' ' + cible.innerHTML);
		console.log('DRAG & DROP == FIN ==');
		
		if(cible.id == "poubelle-tache" && origine.className.indexOf('liste-taches') != -1)
		{
            atterrirDansPoubelle(obj);
		}
		else if(obj.className.indexOf('action') != -1)
		{
			resterDansListe(obj, origine);
		}
		else if(origine.className.indexOf('plan') != -1 && cible.className.indexOf('plan') != -1)
		{
			quitterUneJournee(obj, origine);
			atterrirDansJournee(obj, cible);
		}
		else if(origine.className.indexOf('plan') != -1)
		{
			quitterUneJournee(obj, origine);
			fusionnerDansListe(obj, cible);
		}
		else if(origine.className.indexOf('liste-taches') != -1 && cible.className.indexOf('plan') != -1)
		{
			resterDansListe(obj, origine);
			atterrirDansJournee(obj, cible);
		}
		else if(cible.className.indexOf('liste-taches') != -1)
		{
			//quitterUneListe(obj, origine);
			atterrirDansListe(obj, cible);
		}
		else if(cible.className.indexOf('plan') != -1)
		{
			atterrirDansJournee(obj, cible);
		}
		else if(cible.parentNode.className.indexOf('plan') != -1)
		{
			resterDansListe(obj, origine);
			atterrirDansJournee(obj, cible.parentNode);
		}
		else if(cible.className.indexOf('tache') != -1 || cible.className.indexOf('detail') != -1)
		{
			resterDansListe(obj, origine);
			atterrirDansJournee(obj, cible.parentNode.parentNode);
		}
		else
		{
			resterDansListe(obj, origine);
            // cible.removeChild(obj);
            // nepasAtterrir();
		}		
    }
    
    </script>

    
    <script type="text/javascript">
    afficherTableauTaches();
    afficherCalendrier();
    
    /*
    var optionsDeJournee = {
        direction: 'vertical',
        copy: true, copySortSource: false,
        revertOnSpill: false, removeOnSpill: false, 
        mirrorContainer: document.body,    
        ignoreInputTextSelection: false,
        accepts: function (obj, target, source, sibling) 
        {
            return sibling === null || obj.className.indexOf("action") == -1  || true;
        }
    };*/
    
    
	var lesQuatresSortes = [document.querySelector('#exercer'), document.querySelector('#etudier'), document.querySelector('#creer'), document.querySelector('#construire')];
    var deplacements = picnic(listeCiblesJour.concat(lesQuatresSortes), atterrir);
    picnicHost(document.querySelector("#poubelle-tache"));
    preparerSauvegardeTaches();
    </script>
    
</body>
</html>
