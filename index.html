<html>
<head>

<style>

    *
    {
        padding:0;
        margin:0;
    }
    
    li
    {
        list-style-type:none;
        background-color:red;
        width:200px;
        margin:10px;
        padding:10px 10px 5px 10px;
        margin-bottom:5px;
        padding:4px;
        border-radius:10px;
        height:30px;
        text-align:center;
        line-height:30px;
        font-weight:bold;
        color:#333333;
        cursor:hand;    
    }
    
    #actions
    {
        border-bottom:solid 1px #aaaaaa;
    }

    #tableau-des-taches
    {
        clear:both;
		text-align: center;
		display:flex;
		justify-content:center;
		background-color:#cccccc;
    }
    #tableau-des-taches ul[title]::before 
    {
        text-transform:capitalize;
        content: attr(title);
        display: block;
        font-weight: bold;
        padding: 4px;
    }    
    #tableau-des-taches .liste-taches
    {
        color:white;
        font-size:30px;
        font-family:Verdana;
        list-style-type:none;
        background-color:orange;
        float:left;
        width:230px;
        margin:10px;
        padding:10px 10px 5px 10px;
    
    }
    #tableau-des-taches .liste-taches *
    {
    
        background-color:white;
        font-size:20px;
        margin-bottom:5px;
        padding:4px;
        border-radius:10px;
        height:30px;
        text-align:center;
        line-height:30px;
        font-weight:bold;
        color:#333333;
        cursor:hand;    
    }
    #formulaire-nouvelle-tache 
    {
        background-color:#beedbb;
        border-radius:1.5em;
        padding:1em;
        border:solid 0.2em black;
		margin-top:1em;
		width:12em;
		margin-left:-6em;
		left:50%;
		
    }
    #formulaire-nouvelle-tache form div
    {
        padding:5px;
    }
    #formulaire-nouvelle-tache form div label
    {
        display:block;
		font-weight:bold;
		color:#333333;
    }
    #formulaire-nouvelle-tache form div input
    {
        width:100%;
    }
	
	#calendrier
	{
        position:relative;
        clear:both;
		text-align: center;
		display:flex;
		justify-content:center;	
	}
	
	/* https://stackoverflow.com/a/12686489 */
	#calendrier .action-voyager-temps:before 
	{
        content: '';
        display: inline-block;
        height: 100%;
        vertical-align: middle;
        margin-right: 0em;
    }
	
	#calendrier .action-voyager-temps
	{
        display:inline-block;
        font-size:30px;
        font-weight:bold;
        color:#cccccc;
        text-decoration:none;
        height:100%;
        vertical-align:middle;
	}
	#calendrier .jour
	{
		display:block;
		float:left;
		width:9rem;
		height:20rem;
		background-color:#ccffcc;
		border-radius:0.5rem;
		padding:0.5rem;
		margin:0.5rem;
		
	}
	#calendrier .jour .date
	{
		display:inline-block;
		position:relative;
		font-size:2em;
		color:#333333;
		width:100%;
		font-weight:bold;
		text-align:center;
		margin-right:auto;
		margin-left:auto;
	}
	#calendrier .jour .plan
	{
		background-color:#333333;
		width:9rem;
		min-height:20rem;
		padding-top:0.5rem;
		padding-bottom:0.5rem;
	}
	#calendrier .jour .plan li
	{
		width:7rem;
		height:4em;
		background-color:blue;
		text-align:center;
	}
	#calendrier .jour .plan li.termine
	{
        background-color:green;
	}
	#calendrier .jour .plan .detail
	{
		width:7rem;
		display:block;
		background-color:lightblue;
	}
	#calendrier .jour .plan li input
	{
        width:80px;
	}
	
</style>
</head>
<body>

    <div id="actions">
            <div id="action-tableau-des-taches">
                <a id="action-tableau-des-taches-fermer" href="javascript:fermerTableauTaches()">X</a>
                <a id="action-tableau-des-taches-ouvrir" href="javascript:ouvrirTableauTaches()" style="display:none;">A</a>
                Tableau des t√¢ches possibles 
            </div>
            
    </div>

    <div id="tableau-des-taches">
    

    </div>

    <div id="formulaire-nouvelle-tache" style="display:none;"><form method="post" onsubmit="return enregistrerTache()">
    
    <div>
        <label for="nouvelle-tache-nom">Nom de la tache</label>
        <input type="text" name="nom" id="nouvelle-tache-nom"/>
    </div>
        
    </form></div>
	
	<div id="calendrier">
        <a class="action-voyager-temps" href="javascript:voyagerTemps(-1)">&lt;&lt;</a>
        <div id="calendrier-jours">
        
        </div>
        <a class="action-voyager-temps" href="javascript:voyagerTemps(1)">&gt;&gt;</a>
	</div>
        
    <script type="text/javascript">
    console.log(localStorage.getItem("calendrier"));
    
    var jourCalendrier = new Date();
    
    function voyagerTemps(pas)
    {
        //deplacements.destroy();
        
        console.log("avant " + jourCalendrier.getDate());
        jourCalendrier.setDate(jourCalendrier.getDate()+pas);
        console.log("apres " + jourCalendrier.getDate());
        afficherCalendrier(jourCalendrier);
        console.log("fin " + jourCalendrier.getDate());
        
        //alert(listeCiblesJour);
        //deplacements = dragula(listeCiblesJour.concat(lesQuatresSortes), optionsDeJournee).on("drop", atterrir);
        deplacements = picnic(listeCiblesJour.concat(lesQuatresSortes), /*optionsDeJournee,*/ atterrir);


    }
    
    function fermerTableauTaches()
    {
        var vueDuTableau = document.querySelector('#tableau-des-taches');
        vueDuTableau.style.display = "none";
        document.querySelector('#action-tableau-des-taches-fermer').style.display = "none";
        document.querySelector('#action-tableau-des-taches-ouvrir').style.display = "";
    }

    function ouvrirTableauTaches()
    {
        var vueDuTableau = document.querySelector('#tableau-des-taches');
        vueDuTableau.style.display = "";
        document.querySelector('#action-tableau-des-taches-fermer').style.display = "";
        document.querySelector('#action-tableau-des-taches-ouvrir').style.display = "none";
    }
        
	function cliquerSimple(obj)
    {
        console.log('simple clic');
        console.log('obj ' + obj + ' ' + obj.className);
        if(obj.className.indexOf("termine") == -1) obj.classList.add("termine");
        else  obj.classList.remove("termine");
    }
    function cliquerDouble(obj)
    {
        console.log('double clic');
    }
	var decompte = 0;
	function appliquerGestures(obj) 
	{
        decompte++;
        if (decompte === 1) {
            clicTimer = setTimeout(function() 
            {
                decompte = 0;
                cliquerSimple(obj);
            }, 300);
        } else if (decompte === 2) {
            clearTimeout(clicTimer);
            decompte = 0;
            cliquerDouble(obj);
        }
    };
    
    function ecrireListe(listeTaches)
    {
        var vueDeListe = '';
        for(numeroTache in listeTaches)
        {
            vueDeListe += '<li>'+listeTaches[numeroTache]+'</li>'
        }
        return vueDeListe + actionAjouter;
    }
        
	function atterrirDansListe(obj, cible)
	{
        console.log("atterrirDansListe()");
        var tachesEnregistrees = JSON.parse(localStorage.getItem("taches"));
        localStorage.setItem("taches", JSON.stringify(exporterListes())); // TODO optimiser 		
	}
	function resterDansListe(obj, liste)
	{
        console.log("resterDansListe()");
        //var li = document.createElement('li');
        //li.innerHTML = obj.innerHTML;
        //li.addEventListener('click', function(){appliquerGestures(this)}, false);
		//liste.appendChild(li);
		action = liste.querySelector(".action");
		liste.insertBefore(obj, action);
	}
	function quitterUneListe(obj, liste)
	{
        console.log("quitterUneListe()");
		var objEnDestruction = null;
		var listeTaches = liste.getElementsByTagName('li');
		for(var position = 0; position < listeTaches.length; position++)
		{
			var tache = listeTaches[position];
			if(tache.innerHTML == obj.innerHTML) objEnDestruction = tache;
		}
		//alert(objEnDestruction);
		liste.removeChild(objEnDestruction);
		//delete tableauTaches[liste.id][tache.innerHTML];
	}
	function quitterUneJournee(obj, plan)
	{
        console.log("quitterUneJournee()");
		var objEnDestruction = null;
		var listeTaches = plan.getElementsByTagName('li');
		for(var position = 0; position < listeTaches.length; position++)
		{
			var tache = listeTaches[position];
			if(tache.innerHTML == obj.innerHTML) objEnDestruction = tache;
		}
		if(objEnDestruction) if(tableauCalendrier[plan.parentNode.id][objEnDestruction.innerHTML]) delete tableauCalendrier[plan.parentNode.id][objEnDestruction.innerHTML];
		if(plan.contains(objEnDestruction))plan.removeChild(objEnDestruction);
        localStorage.setItem("calendrier", JSON.stringify(exporterCalendrier())); // TODO optimiser 	
	}
	function enregistrerDetail(obj)
	{
        obj.parentNode.innerHTML = obj.getElementsByTagName('input')[0].value;
        localStorage.setItem("calendrier", JSON.stringify(exporterCalendrier())); // TODO optimiser 	
	}
	function editerDetail(obj)
	{
        obj.innerHTML = '<form onsubmit="enregistrerDetail(this); return false;"><input type="text" value="'+obj.innerHTML+'"></form>';
        obj.onclick = function() {enregistrerDetail(this)};
        obj.getElementsByTagName('input')[0].focus();
	}
	function atterrirDansJournee(obj, cible)
	{
        console.log("atterrirDansJournee()");
        //var calendrierPlan = JSON.parse(localStorage.getItem("calendrier"));
		//alert(JSON.stringify(exporterCalendrier());
		var testTache = obj.childNodes[0];
		if(testTache.className && testTache.className.indexOf('tache') == 0)
		{
            
		}
		else
		{
		    var clone = document.createElement('li');
            clone.addEventListener('click', function(){appliquerGestures(this)}, false);
            clone.innerHTML = '<span class="tache">'+obj.innerHTML+'</span><span class="detail" onclick="editerDetail(this)">&nbsp;</span>';
            picnicJoin(clone);
            cible.appendChild(clone);
        }
        localStorage.setItem("calendrier", JSON.stringify(exporterCalendrier())); // TODO optimiser 	
	}
	
	function fusionnerDansListe(obj, liste)
	{
		if(liste.contains(obj)) liste.removeChild(obj);
	}
        
    function atterrir(obj, cible, origine)
    {
        console.log("atterrir()");
        if(!cible) return false;
		console.log('DRAG & DROP == DEBUT ==');
		console.log('origine : ' + origine + ':' + origine.id + ':' + origine.className + ' ' + origine.innerHTML);
		console.log('obj : ' + obj + ':' + obj.id + ':' + obj.className + ' ' + obj.innerHTML);
		console.log('cible : ' + cible + ':' + cible.id + ':' + cible.className + ' ' + cible.innerHTML);
		console.log('DRAG & DROP == FIN ==');
		
		if(obj.className.indexOf('action') != -1)
		{
			resterDansListe(obj, origine);
		}
		else if(origine.className.indexOf('plan') != -1 && cible.className.indexOf('plan') != -1)
		{
			quitterUneJournee(obj, origine);
			atterrirDansJournee(obj, cible);
		}
		else if(origine.className.indexOf('plan') != -1)
		{
			quitterUneJournee(obj, origine);
			fusionnerDansListe(obj, cible);
		}
		else if(origine.className.indexOf('liste-taches') != -1 && cible.className.indexOf('plan') != -1)
		{
			resterDansListe(obj, origine);
			atterrirDansJournee(obj, cible);
		}
		else if(cible.className.indexOf('liste-taches') != -1)
		{
			quitterUneListe(obj, origine);
			atterrirDansListe(obj, cible);
		}
		else if(cible.className.indexOf('plan') != -1)
		{
			atterrirDansJournee(obj, cible);
		}
    }
        

	function exporterCalendrier()
	{
		var calendrierPlan = {};
		var calendrier = document.getElementById('calendrier');
		var lesJour = calendrier.getElementsByClassName('jour');
		for(var positionJour = 0; positionJour < lesJour.length; positionJour++)
		{
			var jour = lesJour[positionJour];
			var lesChoix = jour.getElementsByClassName('tache');
	
			calendrierPlan[jour.id] = [];
			
			for(var positionChoix = 0; positionChoix < lesChoix.length; positionChoix++)
			{
				var choix = lesChoix[positionChoix];
				var plan = {};
				plan['nom'] = choix.innerHTML;
				plan['detail'] = choix.parentNode.getElementsByClassName('detail')[0].innerHTML;
				if(!plan['detail']) plan['detail'] = '';
				calendrierPlan[jour.id][calendrierPlan[jour.id].length] = plan;
				//calendrierPlan[jour.id][calendrierPlan[jour.id].length]['detail'] = choix.parentNode.getElementsByClassName('detail')[0].innerHTML;
			}
		}
		return calendrierPlan;
	}
		
    function exporterListes()
    {
        var donnees = {};
        donnees["exercer"] = lireListe("exercer");
        donnees["etudier"] = lireListe("etudier");
        donnees["creer"] = lireListe("creer");
        donnees["construire"] = lireListe("construire");
        return donnees;
    }
    function lireListe(liste)
    {
        if(!document.getElementById(liste)) return;
    
        var donneesListe = [];
        lesTachesExercer = document.getElementById(liste).getElementsByTagName("li");
        for(var position = 0; position < lesTachesExercer.length; position++)
        {
            var tache = lesTachesExercer[position];
            if(tache.className.indexOf("action") == -1) donneesListe[donneesListe.length] = tache.innerHTML;
        }
        return donneesListe;
    }
    var listeEnEdition = "";
    
    function ajouterTache(liste)
    {
        var boite = document.querySelector("#formulaire-nouvelle-tache");
        boite.style.display = "block";
        boite.style.position = "absolute";
        //boite.style.x = event.clientX;
        //boite.style.y = event.clientY;
		document.getElementById("nouvelle-tache-nom").focus();
        listeEnEdition = liste;
    }
    function enregistrerTache()
    {
        var boite = document.querySelector("#formulaire-nouvelle-tache");
        boite.style.display = "none";
        lesTaches = JSON.parse(localStorage.getItem("taches"));
        lesTaches[listeEnEdition.id][lesTaches[listeEnEdition.id].length] = document.querySelector("#nouvelle-tache-nom").value;
        //alert(lesTaches[listeEnEdition.id]);
        listeEnEdition.innerHTML = ecrireListe(lesTaches[listeEnEdition.id]);
        localStorage.setItem("taches", JSON.stringify(lesTaches));
        document.querySelector("#nouvelle-tache-nom").value = "";
        return false;
    }
        
    var actionAjouter = '<li class="action" onClick="ajouterTache(this.parentNode)">+</li>';
    function afficherTableauTaches()
    {
        var tachesParDefaut = {"exercer":["natation","danse","film"],"etudier":["internet","herboristerie","survie","irlandais"],"creer":["formation","page web","arbre"],"construire":["menage","reno","produit"]};
        var tachesEnregistrees = JSON.parse(localStorage.getItem("taches"));	
        var tableauTaches = tachesParDefaut;
        if(localStorage.getItem("taches") && localStorage.getItem("taches").length != 0)
        {
            tableauTaches = tachesEnregistrees;
        }
        else
        {
            localStorage.setItem("taches", JSON.stringify(tachesParDefaut));
        }
                    
        var vueDuTableau = document.querySelector('#tableau-des-taches');
        for(nomListe in tableauTaches)
        {
            var listeTaches = tableauTaches[nomListe];        
            vueDuTableau.innerHTML += '<ul id="'+ nomListe+'" class="liste-taches" title="'+nomListe+'">'+ecrireListe(listeTaches) + '</ul>';
        }

    }
    afficherTableauTaches();
    
		
	var lesQuatresSortes = [document.querySelector('#exercer'), document.querySelector('#etudier'), document.querySelector('#creer'), document.querySelector('#construire')];

	
    var listeCiblesJour = [];
    var calendrierParDefaut = {};
    var tableauCalendrier = calendrierParDefaut;
	function afficherCalendrier(jourCalendrier = new Date())
	{
	
        var calendrierEnregistre = JSON.parse(localStorage.getItem("calendrier"));	
        if(localStorage.getItem("taches") && localStorage.getItem("taches").length != 0)
        {
            tableauCalendrier = calendrierEnregistre;
        }
        else
        {
            localStorage.setItem("calendrier", JSON.stringify(calendrierParDefaut));
        }
        //alert(JSON.stringify(tableauCalendrier));

        var vueCalendrier = document.getElementById("calendrier-jours");
        vueCalendrier.innerHTML = "";
        
        var jour = new Date(JSON.parse(JSON.stringify(jourCalendrier)));
        for(var jourSemaine = 0; jourSemaine < 7; jourSemaine++, jour.setDate(jour.getDate()+1))
        {
            var ladate = jour.getFullYear() + '-' + (jour.getMonth()+1) + '-' + jour.getDate();
            //vueCalendrier.innerHTML += '<div class="jour" id="jour-' + ladate + '"><span class="date">' + ladate + '<span><ul class="plan"></ul></div>';
            var autreJour = document.createElement("div");
            autreJour.id = 'jour-' + ladate;
            autreJour.className = 'jour';
            autreJour.innerHTML = '<span class="date">' + ladate + '<span>';
            var planDeJournee = document.createElement('ul');
            planDeJournee.className = 'plan';
            //alert(tableauCalendrier['jour-'+ladate]);
            //alert(tableauCalendrier[ladate].length);
            if(tableauCalendrier && tableauCalendrier['jour-'+ladate])
            for(var positionChoix = 0; positionChoix < tableauCalendrier['jour-'+ladate].length; positionChoix++)
            {
                console.log(JSON.stringify(descriptionTache));
                var descriptionTache = tableauCalendrier['jour-'+ladate][positionChoix];
                if(!descriptionTache['detail']) descriptionTache['detail'] = '';
                planDeJournee.innerHTML += '<li onclick="appliquerGestures(this)"><span class="tache">'+descriptionTache['nom']+'</span><span class="detail" onclick="editerDetail(this)">'+descriptionTache['detail']+'</span></li>';
            }
            
            autreJour.appendChild(planDeJournee);
            vueCalendrier.appendChild(autreJour);
            listeCiblesJour[listeCiblesJour.length] = planDeJournee;
        }
    }
    
    afficherCalendrier();
    
    /*
    var optionsDeJournee = {
        direction: 'vertical',
        copy: true, copySortSource: false,
        revertOnSpill: false, removeOnSpill: false, 
        mirrorContainer: document.body,    
        ignoreInputTextSelection: false,
        accepts: function (obj, target, source, sibling) 
        {
            return sibling === null || obj.className.indexOf("action") == -1  || true;
        }
    };*/
    
    
    
    var picnicFinishCallback;
    var origine;
    var traveler;
    var cible;
    function picnicStart(evenement)
    {
        traveler = evenement.target;
        origine = evenement.target.parentNode;
        //alert('traveler ' + traveler);
        //alert(evenement.target.innerHTML);
    }
    function picnicStop(evenement)
    {
        evenement.preventDefault();
    }
    function picnicFinish(evenement)
    {
        evenement.preventDefault();
        //var data = evenement.dataTransfer.getData("text");
        //evenement.target.appendChild(document.getElementById(data));
        cible = evenement.target;
        cible.appendChild(traveler);
        picnicFinishCallback(traveler, cible, origine);
    }
    
    function picnic(listeZones, atterrir)
    {
        for(positionZone = 0; positionZone < listeZones.length; positionZone++)
        {
            zone = listeZones[positionZone];
            listeObjets = zone.childNodes;
            for(positionObjet = 0; positionObjet < listeObjets.length; positionObjet++)
            {
                objet = listeObjets[positionObjet];
                objet.draggable = true;
                objet.ondragstart = picnicStart;
            }
            zone.ondragover = picnicStop;
            zone.ondrop = picnicFinish;
            picnicFinishCallback = atterrir;
        }
    }
    
    function picnicJoin(objet)
    {
          objet.draggable = true;
          objet.ondragstart = picnicStart;    
    }
    
	var deplacements = picnic(listeCiblesJour.concat(lesQuatresSortes), atterrir);
	

    </script>
    
</body>
</html>
